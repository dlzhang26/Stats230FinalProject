---
title: "Season's Information and Post Injury Play Time For NFL Players"
author: 'Group D: Arthur, Donna, Kaitlyn, Michael'
date: "Friday, April 6, 2024"
output:
  pdf_document:
    fig_height: 3
    fig_width: 5
  word_document: default
---

```{r include=FALSE}
library(mosaic)
library(GGally)
require(tidyr)
require(car)
library(broom)
library(tidyverse)
require(lattice)
library(gridExtra)
library(grid)
library(leaps)
library(lubridate) # finding age at a given date
options(scipen=5)
```

```{r include=FALSE}
# Some customization.  You can alter or delete as desired (if you know what you are doing).
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small"    # slightly smaller font for code
)
trellis.par.set(theme=theme.mosaic())  
options(digits=5)
```


```{r, include=FALSE, warning = FALSE, echo = FALSE}
###############################################################################################
#getwd() in console to find the directory where the csv file is stored on your computer
#For your computer you need to change the path so you can reed the file
#alldata <- read.csv("/home/class26/FIRSTPARTOFEMAIL/ConcussionInjuries2012-2014.csv") 

##Donna's computer
df1 <- read.csv("C:/Users/donna/OneDrive/Documents/STAT230/Stats230FinalProject/ConcussionInjuries2012-2014.csv")
df2 <- read.csv("C:/Users/donna/OneDrive/Documents/STAT230/Stats230FinalProject/HeadInjuredPlayers.csv")


#For Kaitlyn's computer
#df1 <- read.csv("/home/class27/khuang27/StatsProjectFinal/ConcussionInjuries2012-2014.csv")
#df2 <- read.csv("/home/class27/khuang27/StatsProjectFinal/HeadInjuredPlayers.csv")

#For Arthur's computer
#df1 <- read.csv("/home/class26/anwobi26/Stats230_proj/ConcussionInjuries2012-2014.csv")
#df2 <- read.csv("/home/class26/anwobi26/Stats230_proj/HeadInjuredPlayers.csv")

###############################################################################################
##Merge
## gets rid of players who had multiple injuries in the three years
mergeData <- merge(x = df2, y = df1[!duplicated(df1$Player), ], by = "Player", all.x = TRUE)
mergeData <- filter(mergeData, Reported.Injury.Type == "Concussion") ## filter so there's only concussions 

## qual --> quant var
mergeData$Play.Time.After.Injury = parse_number(mergeData$Play.Time.After.Injury)
mergeData$Average.Playtime.Before.Injury = parse_number(mergeData$Average.Playtime.Before.Injury)
###############################################################################################
##rename variables
nameData <- rename(mergeData, OppTeam = Opposing.Team, PostIPT = Play.Time.After.Injury, PreseasonInjury = Pre.Season.Injury., OnWinningTeam = Winning.Team., amtTimeInjured = Weeks.Injured, WeekOfInjury = Week.of.Injury, UnknownInjury = Unknown.Injury., ReportedTypeOfInjury = Reported.Injury.Type, PreIPT = Average.Playtime.Before.Injury, TotalSnaps = Total.Snaps, amtGamesMissed = Games.Missed, GM12 = X2012.2013...Games.Missed, GM13 = X2013.2014...Games.Missed, GM14 = X2014.2015...Games.Missed, I12 = X2012.2013...Number.of.Injuries , I13 = X2013.2014...Number.of.Injuries, I14 = X2014.2015...Number.of.Injuries, TotalInjuries = Total.Number.of.Injuries..2012.2014., PosDuringInjury = Roles.during.injuries, DOB = Date.of.Birth, AgeAtConcussion = Age.first.concussion..2012.2014., totalGamesMissed = Total.Games.Missed..2012.2014., TeamDurConcussion = Team.s..during.concussion.incidents.2012.2014, DOI = Date)

###############################################################################################
## select variables 
studyD <- nameData %>% 
  select(PostIPT, PreseasonInjury, Season, amtGamesMissed, PreIPT, WeekOfInjury, TotalSnaps, Player, I12, I13, I14, TotalInjuries, GM12, GM13, GM14,totalGamesMissed, DOB, DOI, AgeAtConcussion, Position, Team)

## getting the current age 
# Convert DOB to date objects
studyD$DOB <- as.Date(as.character(studyD$DOB), format = "%d/%m/%Y")

# Calculate current age
given_date <- as.Date("2024-04-01")
current_age_in_years <- as.numeric(interval(studyD$DOB, given_date) / dyears(2))
studyD$CurrentAge <- round(current_age_in_years, 1)

#############################################################################
## this re-categorizes position to offense and defense
studydata <- studyD %>% 
    mutate(Position = case_when(
    Position %in% c("Defensive End", "Defensive Tackle", "Safety", "Comerback" ) ~ "defense",
    Position %in% c("Long Snapper", "Wide Receiver", "Tight End", "Linebacker", "Quarterback", "Center", "Guard", "Full Back", "Running Back", "Offensive Tackle") ~ "offense"))
#############################################################################
## this re-categorizes team to 2 conferences
studydata <- studydata %>% 
    mutate(Team = case_when( 
      Team %in% c("Baltimore Ravens", "Cincinnati Bengals", "Cleveland Browns", "Pittsburgh Steelers", "Buffalo Bills", "New England Patriots", "New York Jets" , "Miami Dolphins", "Houston Texans", "Jacksonville Jaguars", "Tennessee Titans", "Indianapolis Colts", "Denver Broncos", "Kansas City Chiefs", "San Diego Chargers", "Oakland Raiders") ~ "AFC",
    Team %in% c("Chicago Bears", "Detroit Lions", "Green Bay Packers", "Minnesota Vikings", "New York Giants", "Philadelphia Eagles", "Washington Redskins", "Dallas Cowboys", "Carolina Panthers", "Tampa Bay Buccaneers", "New Orleans Saints", "Atlanta Falcons", "Arizona Cardinals", "Seattle Seahawks", "San Francisco 49ers", "St. Louis Ram") ~ "NFC"))

#############################################################################
## creating population and sample
predictData <-filter(studydata, Season == "2014/2015") ## data for the season we're 

#############################################################################

studydata <- filter(studydata, PreseasonInjury == "No") ## filters out players who have gotten preseason injury bc not enough observations. 
finalData <- filter(studydata, Season != "2014/2015") ## our sample data


finalData1 <- select(finalData, "PostIPT" , "amtGamesMissed", "PreIPT", "TotalSnaps", "WeekOfInjury", "AgeAtConcussion", "PreseasonInjury", "Position", "Team")
```

## UNIVARIATE ANALYSIS

### RESPONSE VARIABLE: 
Post-Injury Play Time - Descriptive statistics and a frequency histogram with a density plot are shown below. 
```{r, warning = FALSE, echo = FALSE, fig.height = 2, fig.width = 3}
##PostIPT RESPONSE VARIABLE
favstats(~PostIPT, data = finalData1)
gf_dhistogram(~PostIPT, data = finalData1)%>%
  gf_dens()

```

### EXPLANATORY VARIABLES:
amtGamesMissed, PreIPT, WeekOfInjury, and AgeAtConcussion are shown below as histograms. PreseasonInjury and Position are shown below as tallies.

```{r, warning = FALSE, echo = FALSE}
##EXPLANATORY VARIABLES

## quantitative

m1 <- gf_dhistogram(~amtGamesMissed, data = finalData1)%>%
  gf_dens()

m2 <- gf_dhistogram(~PreIPT, data = finalData1) %>%
  gf_dens()

m3 <- gf_dhistogram(~WeekOfInjury, data = finalData1)%>%
  gf_dens()

m4 <- gf_dhistogram(~AgeAtConcussion, data = finalData1, main = "AgeOfFirstConcussion") %>%
  gf_dens()

m5 <- gf_dhistogram(~ TotalSnaps, data = finalData1)%>%
  gf_dens()

##qualitative
m6 <- gf_bar(~ Position, data = finalData1, fill = c("lavender", "skyblue"), main = "Number of Preseason Injuries")


```
```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 15}
grid.arrange(m1, m2, m3, ncol = 3 ) 
```

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 15 }
grid.arrange( m5, m4, m6, ncol = 3 ) 
```

## BIVARIATE ANALYSIS

### Post-Injury Play-Time vs. Position. 
We will represent this with a box plot, where the two categories are defense and offense. 

```{r}
gf_boxplot(PostIPT ~ Position, data = finalData1)%>%
  gf_labs(title = "Post-Injury Play-Time vs. Position")

gf_dens( ~ PostIPT, color = ~Position, data = finalData1)%>%
  gf_labs(title = "Post-Injury Play-Time vs. Position")
favstats(PostIPT ~ Position, data = finalData1)
```


### Post-Injury Play-Time vs. Total Snaps.
We will represent this with a scatterplot. 

```{r}


gf_point(PostIPT ~ TotalSnaps, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play-Time vs. Total Snaps")

PostIPTvsTotalSnaps <- lm(PostIPT ~ PreIPT, data = finalData1)
mplot(PostIPTvsTotalSnaps, which = 1)
mplot(PostIPTvsTotalSnaps, which = 2)
cor(PostIPT ~ TotalSnaps, data = finalData1, use = "pairwise")
```


### Post-Injury Play-Time vs. Pre-Injury Play Time.
We will represent this with a scatterplot. 

```{r}
gf_point(PostIPT ~ PreIPT, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Pre-Injury Play Time")

PostIPTvsPreIPT <- lm(PostIPT ~ PreIPT, data = finalData1)
mplot(PostIPTvsPreIPT, which = 1)
mplot(PostIPTvsPreIPT, which = 2)
cor(PostIPT ~ PreIPT, data = finalData1, use = "pairwise")
```

### Post-Injury Play-Time vs. AgeAtConcussion.
We will represent this with a scatterplot.

```{r}
gf_point(PostIPT ~ AgeAtConcussion, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Age at Concussion")
PostIPTvsAge <- lm(PostIPT ~ AgeAtConcussion, data = finalData1)
mplot(PostIPTvsAge, which = 1)
mplot(PostIPTvsAge, which = 2)
cor(PostIPT ~ AgeAtConcussion, data = finalData1, use = "pairwise")
```

```{r}
gf_point(PostIPT ~ AgeAtConcussion, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Age at Concussion")
PostIPTvsAge <- lm(PostIPT ~ AgeAtConcussion, data = finalData1)
mplot(PostIPTvsAge, which = 1)
mplot(PostIPTvsAge, which = 2)
msummary(PostIPTvsAge)
cor(PostIPT ~ AgeAtConcussion, data = finalData1, use = "pairwise")
```



### Post-Injury Play-Time vs. Week of Injury.
We will represent this with a scatterplot.

```{r}
gf_point(PostIPT ~ WeekOfInjury, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Week of Injury")
PostIPTvsWeekofInjury <- lm(PostIPT ~ WeekOfInjury, data = finalData1)
mplot(PostIPTvsWeekofInjury, which = 1)
mplot(PostIPTvsWeekofInjury, which = 2)
cor(PostIPT ~ WeekOfInjury, data = finalData1, use = "pairwise")
```

### Post-Injury Play-Time vs. amtGamesMissed.
We will represent this with a scatterplot.

```{r}
gf_point(PostIPT ~ amtGamesMissed, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Amount of Games Missed")

PostIPTvs.GamesMissed <- lm(PostIPT ~ amtGamesMissed, data = finalData1)
mplot(PostIPTvs.GamesMissed, which = 1)
mplot(PostIPTvs.GamesMissed, which = 2)
cor(PostIPT ~ amtGamesMissed, data = finalData1, use = "pairwise")
```


##Final Model (As of now)
```{r}

#ggpairs(finalData1)

```

```{r}


finalData1 <- select(finalData, "Player","PostIPT" , "PreIPT", "WeekOfInjury", "AgeAtConcussion", "Position")


fm.full <- lm(PostIPT ~ PreIPT +WeekOfInjury + AgeAtConcussion + Position , data = finalData1)
anova(fm.full)

modA <- lm(PostIPT ~ PreIPT, data = finalData1)
anova(modA)
msummary(modA)
mplot(modA, which = 1 )
mplot(modA, which = 2 )

mod1 <- lm(PostIPT ~ PreIPT + Position, data = finalData1)
anova(mod1)
msummary(mod1)
mplot(mod1, which = 1 )
mplot(mod1, which = 2 )
mplot(mod1, which = 4)
mplot(mod1, which = 5 )
mplot(mod1, which = 6 )

```
```{r}

finalDataAug <- augment(mod1) 

```


```{r}

mod2a <- lm(PostIPT ~ PreIPT + Position, data = finalDataAug, subset =  abs(finalDataAug$.resid) < 50 )## need to describe who they were and why you are removing -- this removed 2
mod2aRemoved <- filter(finalDataAug, abs(.resid) > 50 )

anova(mod2a)
msummary(mod2a)
mplot(mod2a, which = 1 )
mplot(mod2a, which = 2 )
mplot(mod2a, which = 4 )
mplot(mod2a, which = 5 )
mplot(mod2a, which = 6 )

```

```{r}

mod2 <- lm(PostIPT ~ PreIPT + Position, data = finalDataAug, subset =  abs(finalDataAug$.resid) < 40 )## need to describe who they were and why you are removing -- this removed 6. might be too many
anova(mod2)
msummary(mod2)
mplot(mod2, which = 1 )
mplot(mod2, which = 2 )
mplot(mod2, which = 4 )
mplot(mod2, which = 5 )
mplot(mod2, which = 6 )

```




