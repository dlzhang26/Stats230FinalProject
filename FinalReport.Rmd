---
title: "Predicting Post Injury Play Time For NFL Players"
author: 'Group D: Arthur, Donna, Kaitlyn, Michael'
date: "5/7/2024"
output:
  pdf_document:
    fig_height: 3
    fig_width: 5
  word_document: default
---

```{r include=FALSE}
library(mosaic)
library(GGally)
require(tidyr)
require(car)
library(broom)
library(tidyverse)
require(lattice)
library(gridExtra)
library(grid)
library(leaps)
library(lubridate) # finding age at a given date
options(scipen=5)
```

```{r include=FALSE}
# Some customization.  You can alter or delete as desired (if you know what you are doing).
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small"    # slightly smaller font for code
)
trellis.par.set(theme=theme.mosaic())  
options(digits=5)
```


```{r, include=FALSE, warning = FALSE, echo = FALSE}
###############################################################################################
#getwd() in console to find the directory where the csv file is stored on your computer
#For your computer you need to change the path so you can reed the file
#alldata <- read.csv("/home/class26/FIRSTPARTOFEMAIL/ConcussionInjuries2012-2014.csv") 

##Donna's computer
#df1 <- read.csv("C:/Users/donna/OneDrive/Documents/STAT230/Stats230FinalProject/ConcussionInjuries2012-2014.csv")
#df2 <- read.csv("C:/Users/donna/OneDrive/Documents/STAT230/Stats230FinalProject/HeadInjuredPlayers.csv")


#For Kaitlyn's computer
df1 <- read.csv("/home/class27/khuang27/Stats230FP/ConcussionInjuries2012-2014.csv")
df2 <- read.csv("/home/class27/khuang27/Stats230FP/HeadInjuredPlayers.csv")

#For Arthur's computer
#df1 <- read.csv("/home/class26/anwobi26/Stats230_proj/ConcussionInjuries2012-2014.csv")
#df2 <- read.csv("/home/class26/anwobi26/Stats230_proj/HeadInjuredPlayers.csv")

###############################################################################################
##Merge
## gets rid of players who had multiple injuries in the three years
mergeData <- merge(x = df2, y = df1[!duplicated(df1$Player), ], by = "Player", all.x = TRUE)
mergeData <- filter(mergeData, Reported.Injury.Type == "Concussion") ## filter so there's only concussions 

## qual --> quant var
mergeData$Play.Time.After.Injury = parse_number(mergeData$Play.Time.After.Injury)
mergeData$Average.Playtime.Before.Injury = parse_number(mergeData$Average.Playtime.Before.Injury)
###############################################################################################
##rename variables
nameData <- rename(mergeData, OppTeam = Opposing.Team, PostIPT = Play.Time.After.Injury, PreseasonInjury = Pre.Season.Injury., OnWinningTeam = Winning.Team., amtTimeInjured = Weeks.Injured, WeekOfInjury = Week.of.Injury, UnknownInjury = Unknown.Injury., ReportedTypeOfInjury = Reported.Injury.Type, PreIPT = Average.Playtime.Before.Injury, TotalSnaps = Total.Snaps, amtGamesMissed = Games.Missed, GM12 = X2012.2013...Games.Missed, GM13 = X2013.2014...Games.Missed, GM14 = X2014.2015...Games.Missed, I12 = X2012.2013...Number.of.Injuries , I13 = X2013.2014...Number.of.Injuries, I14 = X2014.2015...Number.of.Injuries, TotalInjuries = Total.Number.of.Injuries..2012.2014., PosDuringInjury = Roles.during.injuries, DOB = Date.of.Birth, AgeAtConcussion = Age.first.concussion..2012.2014., totalGamesMissed = Total.Games.Missed..2012.2014., TeamDurConcussion = Team.s..during.concussion.incidents.2012.2014, DOI = Date)

###############################################################################################
## select variables 
studyD <- nameData %>% 
  select(PostIPT, PreseasonInjury, Season, amtGamesMissed, PreIPT, WeekOfInjury, TotalSnaps, Player, I12, I13, I14, TotalInjuries, GM12, GM13, GM14,totalGamesMissed, DOB, DOI, AgeAtConcussion, Position, Team, OppTeam, OnWinningTeam)

## getting the current age 
# Convert DOB to date objects
studyD$DOB <- as.Date(as.character(studyD$DOB), format = "%d/%m/%Y")

# Calculate current age
given_date <- as.Date("2024-04-01")
current_age_in_years <- as.numeric(interval(studyD$DOB, given_date) / dyears(2))
studyD$CurrentAge <- round(current_age_in_years, 1)

#############################################################################
## this re-categorizes position to offense and defense
studydata <- studyD %>% 
    mutate(PositionC = case_when(
    Position %in% c("Defensive End", "Defensive Tackle", "Safety", "Comerback" ) ~ "defense",
    Position %in% c("Long Snapper", "Wide Receiver", "Tight End", "Linebacker", "Quarterback", "Center", "Guard", "Full Back", "Running Back", "Offensive Tackle") ~ "offense"))
#############################################################################


#############################################################################
## creating population and sample
predictData <-filter(studydata, Season == "2014/2015") ## data for the season we are predicting

#############################################################################

tally(~PreseasonInjury,data = studydata)

m6a <- gf_bar(~PreseasonInjury,data = studydata)%>%
  gf_labs(title = "Fig. 6a. Pre-season Injury", x = "Pre-season Injury (Yes/No)") 


finalData <- filter(studydata, PreseasonInjury == "No") ## filters out players who have gotten preseason injury bc not enough observations. 


finalData1 <- select(finalData, "PostIPT" ,"PreIPT", "amtGamesMissed", "WeekOfInjury", "AgeAtConcussion", "PreseasonInjury", "Position","Team", "OnWinningTeam", "PositionC", "Player")
studydata <- filter(studydata, Season != "2014/2015") ## our sample data

finalData1 <- select(finalData, "PostIPT" ,"PreIPT", "amtGamesMissed", "WeekOfInjury", "AgeAtConcussion", "PreseasonInjury", "Position","Team", "OnWinningTeam", "PositionC", "Player")

finalData1 <- mutate(finalData1, amtGamesMissedC = cut(amtGamesMissed, breaks = c(0, 0.5, 1.5, 20), labels = c("less than 1 games", "one game", "two or more games"), include.lowest = TRUE))
```


# **Abstract**
Insert abstract here.


# **Background and Meaning**
Insert stuff here.


# **Methods**

## Data Set
Insert description of data set here.

## Variables
Insert information on variables here.

## Statistical Models
Insert info on statistical models here.


# **Results**

## Univariate Exploratory Data Analysis

### Response Variable

Our response variable for this study is Post-Injury Play Time.  

```{r, warning = FALSE, echo = FALSE, fig.height = 2, fig.width = 3}
gf_dhistogram(~PostIPT, data = finalData1)%>%
  gf_dens()%>%
  gf_labs(title = "Fig. 1. Post-Injury Play Time")
```

**Fig. 1.** The distribution is bimodal, with modes at around 20 downs and 62 downs, and symmetric. The median is 49.5 downs and the IQR is 42.75 downs. The mean is 47.093 downs and the standard deviation is 24.758 downs.

### Explanatory Variables - Qualitative

Our qualitative explanatory variables are Amount of Games Missed, Position, and Pre-Season Injury.

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 10}
AmtGamesMissedUni <- gf_bar(~amtGamesMissedC, data = finalData1, fill = c("darkred","darkblue","darkgreen"))%>%
  gf_dens()%>%
  gf_labs(title = "Amount of Games Missed (Transformed)", x = "Amount of Games Missed")

AmtGamesMissedUniQuant <- gf_dhistogram(~amtGamesMissed, data = finalData1)%>%
  gf_dens()%>%
  gf_labs(title = "Amount of Games Missed (Non-Transformed)", x = "Amount of Games Missed")

PositionUni <- gf_bar(~ PositionC, data = finalData1, fill = c("pink", "skyblue"))%>%
  gf_labs(title = "Position", x = "Position")

PreSeasonInjuryUni <- gf_bar(~ PreseasonInjury, data = studydata, fill = c("pink", "darkgreen"))%>%
  gf_labs(title = "Pre-Season Injury", x = "Pre-Season Injury")

grid.arrange(AmtGamesMissedUni, AmtGamesMissedUniQuant, ncol = 2)
grid.arrange(PositionUni, PreSeasonInjuryUni, ncol = 2)
```
**Fig. 2** Amount of Games Missed, originally quantitative, is heavily right-skewed, indicating that the majority of players did not miss multiple games. And for many, they missed no games. We resultantly transformed this variable into a categorical variable with the categories "Less than 1 games missed," "One game missed," and "Two or more games missed." Regarding position, the categories and corresponding distribution are: defensive end (5.31%), defensive tackle (3.38%), safety (13.04%), comerback (14.98%), long snapper (0.48%), wide receiver (14.98%), tight end (9.18%), linebacker (10.14%), quarterback (4.35%), center (1.93%), guard (6.76%), full back (0.97%), running back (10.63%) and offensive tackle (3.87%). We transformed this variable into two broader categories: "Offense" and "Defense." The distribution is 36.71% defense and 63.29% offense. Finally, regarding Pre-Season Injury, there was an imbalance of observations; only 9 players sustained a pre-season injury in the first two seasons, while 207 players did not. Due to this imbalance, we decided to remove this variable for our bivariate analysis. 


### Explanatory Variables - Quantitative

Our quantitative variables are Pre-Injury Play-Time, Week of Injury and Age at Concussion. 

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 15}
PreIPTUni <- gf_dhistogram(~PreIPT, data = finalData1) %>%
  gf_dens()%>%
  gf_labs(title = "Average Pre-Injury Play Time", x = "Pre-Injury Play Time (downs)")

WeekofInjuryUni <- gf_dhistogram(~WeekOfInjury, data = finalData1)%>%
  gf_dens()%>%
  gf_labs(title = "Week of Injury", x = "Week of Injury")

AgeAtConcussionUni <- gf_dhistogram(~AgeAtConcussion, data = finalData1, main = "AgeOfFirstConcussion") %>%
  gf_dens()%>%
  gf_labs(title = "Age at First Concussion", x = "Age at First Concussion")

grid.arrange(PreIPTUni, WeekofInjuryUni, AgeAtConcussionUni, ncol = 3) 
```
**Fig. 3.** The distribution of Pre-Injury Play Time is unimodal and slightly skewed to the left. The median is 51 downs and the IQR is 32 downs. The mean is 47.418 downs and the standard deviation is 19.577 downs. Week of Injury looks bimodal and almost uniform, with one main mode at week 10. The median is 10 weeks and the IQR is 8 weeks. The mean is 9.48 weeks and the standard deviation is 4.69 weeks. The distribution of Age at Concussion is unimodal and slightly skewed to the right. The median is 26.31 years and the IQR is 4.07 years. The mean is 26.497 years and the standard deviation is 2.8941 years. 


## Bivariate Exploratory Data Analysis

### Qualitative Variables

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 12}
PositionBiv <- gf_boxplot(PostIPT ~ PositionC, data = finalData1)%>%
  gf_labs(title = "Post-Injury Play-Time vs. Position", x = "Position", y = "Post-Injury Play Time")

AmtgamesmissedBiv <- gf_boxplot(PostIPT ~ amtGamesMissedC, data = finalData1)%>%
  gf_labs(title = "Post-Injury Play-Time vs. Amount of Games Missed", x = "Amount of Games Missed", y = "Post-Injury Play Time")

grid.arrange(PositionBiv, AmtgamesmissedBiv, ncol = 2)
```
**Fig. 4.** Regarding Position, there does not seem to be a massive difference in the median and IQR of Post-Injury Play Time between offensive players (median = 47, IQR = 39) and defensive players (median = 54, IQR = 44.25). This suggests that a player's position may not play a role in their post-injury play time. However, regarding Amount of Games Missed, the median and IQR of Post-Injury Play Time for players who missed two or more games (median = 23, IQR = 39) looks lower than that of players who missed one game (median = 51, IQR = 43. 25) and players who missed no games (median = 49, IQR = 41.25). This suggests that the more games a player misses, the less play time they get after the injury. 

### Quantitative Variables

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 7}
PreIPTOutliers <- gf_point(PostIPT ~ PreIPT, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Pre-Injury Play Time (Outliers)", x = "Pre-Injury Play Time", y = "Post-Injury Play Time")
```
```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 12, fig.show='hide'}
#Hid these plots. 
PostIPTvsPreIPTOutliers <- lm(PostIPT ~ PreIPT, data = finalData1)
PostIPTvsPreIPTOutliersResids <- mplot(PostIPTvsPreIPTOutliers, which = 1)
PostIPTvsPreIPTOutliersQQ <- mplot(PostIPTvsPreIPTOutliers, which = 2)
```

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 10}
grid.arrange(PreIPTOutliers, PostIPTvsPreIPTOutliersResids, PostIPTvsPreIPTOutliersQQ, ncol = 2)
```
**Fig. 5. Pre-Injury Play Time With the Outliers.** After conducting bivariate analysis for Post-Injury Play Time vs. Pre-Injury Play Time, we noticed outliers at Pre-Injury Play Time = 0 and Pre-Injury Play Time > 80. We removed outlier 32 to improve our equal variance and normality of errors. 

```{r, warning = FALSE, echo = FALSE}
outliers <-finalData1[c(30), ]
FDfiltered <- finalData1[-c(30),]

gf_point(PostIPT ~ PreIPT, data = FDfiltered)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Pre-Injury Play Time (No Outliers)", x = "Pre-Injury Play Time", y = "Post-Injury Play Time")
```
```{r, warning = FALSE, echo = FALSE, fig.show='hide'}
PreIPTFiltered <- lm(PostIPT ~ PreIPT, data = FDfiltered)
PreIPTFilteredResids <- mplot(PreIPTFiltered, which = 1)
PreIPTFilteredQQ <- mplot(PreIPTFiltered, which = 2)
```
```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 10}
grid.arrange(PreIPTFilteredResids, PreIPTFilteredQQ, ncol = 2)
```
**Fig. 6. Pre-Injury Play Time Without the Outlier.** After removing the outlier, the residuals and QQ plot improved. There is a strong, positive, linear relationship between Post-Injury Play Time and Pre-Injury Play Time (r = 0.674). In other words, the more pre-injury play time a player had, the more post-injury play time a player had.  

```{r, warning = FALSE, echo = FALSE, fig.height = 4, fig.width = 12}
AgeAtConcussionBiv <- gf_point(PostIPT ~ AgeAtConcussion, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Age at Concussion", x = "Age at Concussion", y = "Post-Injury Play Time")

WeekofInjuryBiv <- gf_point(PostIPT ~ WeekOfInjury, data = finalData1)%>%
  gf_lm()%>%
  gf_labs(title = "Post-Injury Play Time vs. Week of Injury", x = "Week of Injury", y = "Post-Injury Play Time")

grid.arrange(AgeAtConcussionBiv, WeekofInjuryBiv, ncol = 2)
```
**Fig. 7.** There is little to no relationship between a player's post-injury play time and the age at which they sustained the concussion (r = 0.0605). There is also no relationship between a player's post-injury play time and the week at which they sustained the concussion (r = 0.0159).


## Final Model
Put stuff here.


# **Interpreting the Final Model**
Put interpretation here.


# **Conclusion**
Put conclusion here.
